<?xml version="1.0" encoding="utf-8"?>
<issues>
  <issue>
    <field name="Priority">
      <value>Major</value>
    </field>
    <field name="Type">
      <value>Bug</value>
    </field>
    <field name="State">
      <value>Fixed</value>
    </field>
    <field name="Assignee" />
    <field name="Subsystem">
      <value>Framework</value>
    </field>
    <field name="Fix versions">
      <value>AR 2.0 Alpha 2</value>
    </field>
    <field name="Affected versions">
      <value>AR 2.0</value>
    </field>
    <field name="Fixed in build" />
    <field name="numberInProject">
      <value>261</value>
    </field>
    <field name="summary">
      <value>certain events get registered twice (IPostInsertEventListener, IPostUpdateEventListener &amp; IPostDeleteEventListener)</value>
    </field>
    <field name="description">
      <value>when using the [EventListener] attribute (and by other means as well) any events which inherit from IPostInsertEventListener, IPostUpdateEventListener or IPostDeleteEventListener get registered twice (and therefore the event gets fired twice for that class)

i have narrowed down the issue to the Contribute method of the EventListenerContributer class. It iterates over the 'eventTypes' variable to determine the different types of event listeners (so it can add them to the appropriate properties). however 'eventTypes' (which is generated by NHEventListeners.GetEventListenerTypes() ) contains duplicates because there are some events that share the same interface type e.g. PostUpdate and PostCommitUpdate. This causes the same eventListeners to be registered twice because the same event type is looked at twice by the foreach loop.

i am not really sure how you are going to fix this, because it means that the interface that a listener derives from is not enough to determine the event type (because it is a one-to-many relationship). i guess you should identify it by using a NHibernate.Events.ListenerType property in the attribute instead.

p.s. this is causing me grief because it means my event is firing twice for each update, which means my audit logging has duplicates</value>
    </field>
    <field name="created">
      <value>1244275553000</value>
    </field>
    <field name="updated">
      <value>1244785123000</value>
    </field>
    <field name="reporterName">
      <value>MattF</value>
    </field>
    <field name="updaterName">
      <value>MattF</value>
    </field>
    <field name="resolved">
      <value>1244785080000</value>
    </field>
    <field name="permittedGroup">
      <value>All Users</value>
    </field>
    <comment author="MattF" text="come to think of it, i really want a PostCommitUpdate event instead of a PostUpdate event, but there is no way of doing this using the EventListener attribute" created="1244275604000" />
    <comment author="MattF" text="i have added a patch with a unit test to demonstrate this bug. it probably isn't in a format that you want to commit it into the repo, but it does demonstrate the bug" created="1244276147000" />
    <comment author="mzywitza" text="What about adding a property&#xA;[EventListener(RegisterTo=&quot;regex&quot;)]?&#xA;&#xA;The default value is an empty string, which matches all property names (of NHibernate.Events.EventListener). If any other value is specified, the listener is registered only when the regex matches.&#xA;&#xA;This way you can specify RegisterTo=&quot;Commit&quot; when adding to the commit-hooks only or RegisterTo=&quot;PostUpdate&quot; when adding to the non-commit hook only.&#xA;&#xA;If that is ok for you, drop a line, then I will add the code." created="1244781143000" />
    <comment author="MattF" text="that seems ok by me. however having it register to multiple events by default may confuse people.&#xA;&#xA;NB: at the moment it *doesn't* register to both the PostUpdate event and the CommitUpdate event. It actually registers to the PostUpdate event twice (which is the actual bug)" created="1244781670000" />
    <comment author="MattF" text="* '''Attachment''' ar-261.patch added.&#xD;&#xA;" created="1244276100000" />
    <comment author="mzywitza" text="* '''Status''' changed from ''Open'' to ''Work Started''.&#xD;&#xA;" created="1244780820000" />
    <comment author="mzywitza" text="* '''Status''' changed from ''Work Started'' to ''Work Stopped''.&#xD;&#xA;" created="1244781240000" />
    <comment author="mzywitza" text="* '''Resolution''' set to ''Fixed''.&#xD;&#xA;* '''Version Fixed''' set to ''AR 2.0 Alpha 2''.&#xD;&#xA;* '''Status''' changed from ''Work Stopped'' to ''Resolved''.&#xD;&#xA;" created="1244785080000" />
  </issue>
</issues>